!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=24)}({24:function(t,e,i){"use strict";i.r(e);var s={ratio:1.25,elementTypes:{node:"node",relation:"relation"},properties:["label","fontSize","lineModel","textAlign","textBaseline"],defaultFont:{nodeFontSize:"16px",relationFontSize:"14px",fontFamily:"Microsoft Yahei"},lineOperations:{startPointChange:"startPointChange",endPointChange:"endPointChange",middlePathChange:"middlePathChange"}};const n=10*s.ratio,h=n*Math.sin(45*Math.PI/180),o=n*Math.cos(45*Math.PI/180);class r{constructor(t,e){this.shape=t,this.ctx=e.getContext("2d")}get pointCollection(){let t=[];return t.push(this.firstPoint),t.push(this.secondPoint),t.push(this.thirdPoint),t.push(this.forthPoint),t}get firstPoint(){return{order:1,x:this.shape.center.x,y:this.shape.top}}get secondPoint(){return{order:2,x:this.shape.right,y:this.shape.center.y}}get thirdPoint(){return{order:3,x:this.shape.center.x,y:this.shape.bottom}}get forthPoint(){return{order:4,x:this.shape.left,y:this.shape.center.y}}draw(){this.ctx.save(),this.ctx.fillStyle="rgba(0, 220, 255, 0.6)",this.pointCollection.map(t=>a(t,this.ctx)),this.ctx.restore()}hitCheck(t,e){for(const i of this.pointCollection){const s=l(t,e,i);if(s)return s}return!1}selectPoint(t){this.ctx.fillStyle="rgba(0, 180, 255, 1)",this.pointCollection.map(e=>{e.order===t&&a(e,this.ctx)})}saveState(){let t=[],e={};e.x=this.firstPoint.x-h-1,e.y=this.firstPoint.y-21,e.imgData=this.ctx.getImageData(e.x,e.y,2*h+2,o+2);let i={};i.x=this.secondPoint.x+20-o-1,i.y=this.secondPoint.y-h-1,i.imgData=this.ctx.getImageData(i.x,i.y,o+2,2*h+2);let s={};s.x=this.thirdPoint.x-h-1,s.y=this.thirdPoint.y+20-o-1,s.imgData=this.ctx.getImageData(s.x,s.y,2*h+2,o+2);let n={};return n.x=this.forthPoint.x-21,n.y=this.forthPoint.y-h-1,n.imgData=this.ctx.getImageData(n.x,n.y,o+2,2*h+2),t.push(e),t.push(i),t.push(s),t.push(n),t}connectCheck(t,e){for(const i of this.pointCollection)if((t-i.x)*(t-i.x)+(e-i.y)*(e-i.y)<100)return{order:i.order,distance:(t-i.x)*(t-i.x)+(e-i.y)*(e-i.y)};return!1}}function a(t,e){e.beginPath();let i={},s={};1===t.order?(e.moveTo(t.x,t.y-20),i.x=t.x-h,i.y=t.y-20+o,s.x=t.x+h,s.y=i.y):2===t.order?(e.moveTo(t.x+20,t.y),i.x=t.x+20-o,i.y=t.y-h,s.x=i.x,s.y=t.y+h):3===t.order?(e.moveTo(t.x,t.y+20),i.x=t.x-h,i.y=t.y+20-o,s.x=t.x+h,s.y=i.y):4===t.order&&(e.moveTo(t.x-20,t.y),i.x=t.x-20+o,i.y=t.y-h,s.x=i.x,s.y=t.y+h),e.lineTo(i.x,i.y),e.lineTo(s.x,s.y),e.fill()}function l(t,e,i){return 1===i.order?t>=i.x-h-1&&t<=i.x+h+1&&e>=i.y-21&&e<=i.y-19+o&&i.order:2===i.order?t>=i.x+19-o&&t<=i.x+21&&e>=i.y-h-1&&e<=i.y+h+1&&i.order:3===i.order?t>=i.x-h-1&&t<=i.x+h+1&&e>=i.y+19-o&&e<=i.y+21&&i.order:4===i.order?t>=i.x-21&&t<=i.x-19+o&&e>=i.y-h-1&&e<=i.y+h+1&&i.order:void 0}class c{constructor(t,e){this.shape=t,this.ctx=e.getContext("2d")}get pointCollection(){var t=[];return t.push(this.firstPoint),t.push(this.secondPoint),t.push(this.thirdPoint),t.push(this.forthPoint),t}get firstPoint(){return{order:1,x:this.shape.center.x,y:this.shape.top}}get secondPoint(){return{order:2,x:this.shape.right,y:this.shape.center.y}}get thirdPoint(){return{order:3,x:this.shape.center.x,y:this.shape.bottom}}get forthPoint(){return{order:4,x:this.shape.left,y:this.shape.center.y}}draw(){this.ctx.save(),this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)",this.ctx.lineWidth=.8,this.pointCollection.map(t=>(function(t,e){e.fillRect(t.x-3,t.y-3,6,6),e.strokeRect(t.x-3,t.y-3,6,6)})(t,this.ctx)),this.ctx.restore()}}class d{constructor(t={},e){this.canvas=e,this.ctx=e.getContext("2d"),t.strokeStyle?this.strokeStyle=t.strokeStyle:this.strokeStyle="rgb(0, 0, 0)",t.fillStyle?this.fillStyle=t.fillStyle:this.fillStyle="rgba(0, 0, 0, 1)"}}class x{constructor(t,e){this.shape=t,this.ctx=e.getContext("2d")}get pointCollection(){const t=[];return t.push(this.northPoint),t.push(this.eastPoint),t.push(this.southPoint),t.push(this.westPoint),t.push(this.nePoint),t.push(this.sePoint),t.push(this.swPoint),t.push(this.nwPoint),t}get northPoint(){return{order:"n",x:this.shape.center.x,y:this.shape.top}}get eastPoint(){return{order:"e",x:this.shape.right,y:this.shape.center.y}}get southPoint(){return{order:"s",x:this.shape.center.x,y:this.shape.bottom}}get westPoint(){return{order:"w",x:this.shape.left,y:this.shape.center.y}}get nePoint(){return{order:"ne",x:this.shape.right,y:this.shape.top}}get sePoint(){return{order:"se",x:this.shape.right,y:this.shape.bottom}}get swPoint(){return{order:"sw",x:this.shape.left,y:this.shape.bottom}}get nwPoint(){return{order:"nw",x:this.shape.left,y:this.shape.top}}draw(){this.ctx.save(),this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)",this.ctx.lineWidth=.8,this.ctx.setLineDash([6,3]),this.ctx.lineDashOffset=0,this.ctx.strokeRect(this.nwPoint.x,this.nwPoint.y,this.shape.width,this.shape.height),this.ctx.restore(),this.ctx.save(),this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)",this.ctx.lineWidth=.8,this.pointCollection.map(t=>(function(t,e){e.fillRect(t.x-3,t.y-3,6,6),e.strokeRect(t.x-3,t.y-3,6,6)})(t,this.ctx)),this.ctx.restore()}hitCheck(t,e){for(const i of this.pointCollection)if(t>=i.x-4&&t<=i.x+4&&e>=i.y-4&&e<=i.y+4)return i}}class f extends d{constructor(t,e){super(t,e),this.type=t.shape,this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,t.text&&(this.text=t.text),this.connector=new r(this,e),this.anchor=new c(this,e),this.controller=new x(this,e)}get top(){return this.y-this.height/2}get bottom(){return this.y+this.height/2}get left(){return this.x-this.width/2}get right(){return this.x+this.width/2}get center(){return{x:this.x,y:this.y}}fillText(){let t=this.ctx;if(t&&this.text&&this.text.content){t.lineWidth=1,t.fillStyle="rgba(0, 0, 0, 1)",this.text.fontSize?t.font=this.text.fontSize+" "+s.defaultFont.fontFamily:(t.font=s.defaultFont.nodeFontSize+" "+s.defaultFont.fontFamily,this.text.fontSize=s.defaultFont.nodeFontSize);let e,i,n=this.text.content,h=parseInt((this.text.fontSize||s.defaultFont.nodeFontSize).replace("px","")),o=n.split(""),r="",a=[];for(let e=0;e<o.length;e++)t.measureText(r).width<this.width&&t.measureText(r+o[e]).width<=this.width?r+=o[e]:(a.push(r),r=o[e]);switch(a.push(r),t.textAlign=this.text.textAlign?this.text.textAlign:"center",t.textBaseline=this.text.textBaseline?this.text.textBaseline:"middle",t.textAlign){case"center":e=this.center.x;break;case"left":e=this.left+1;break;case"right":e=this.right-1}switch(t.textBaseline){case"middle":i=this.center.y-(a.length-1)/2*(h+1);break;case"top":i=this.top+1;break;case"bottom":i=this.bottom-(a.length-1)*(h+1)}for(let s=0;s<a.length;s++){const n=a[s];t.fillText(n,e,i+(h+1)*s)}}}selectShape(){this.controller.draw()}hitCheck_Over(t,e){return t>=this.left-20&&t<=this.right+20&&e>=this.top-20&&e<=this.bottom+20}nodeResizing(t,e){return e}}class u extends Error{constructor(t){super(t),this.name="ParameterError"}}const p=10;var y={generateUUID(){let t=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)})},deepClone(t){const e=Object.prototype.toString.call(t);if("[object Object]"!==e&&"[object Array]"!==e)return null;let i="[object Array]"===e?[]:{};for(const e in t)if(Object.hasOwnProperty.call(t,e)){const s=t[e],n=Object.prototype.toString.call(s);i[e]="[object Object]"===n||"[object Array]"===n?this.deepClone(s):s}return i}};const m={rect:class extends f{constructor(t,e){super(t,e)}draw(){let t=this.ctx;t&&(t.save(),t.lineWidth=1.2,t.strokeStyle=this.strokeStyle,t.fillStyle=this.fillStyle,t.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),t.strokeRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),this.fillText(),t.restore())}drawDashNode(t,e){let i=this.ctx;i&&(i.save(),i.strokeStyle=this.strokeStyle,i.lineWidth=1,i.setLineDash([6,3]),i.lineDashOffset=0,i.strokeRect(this.x+t-this.width/2,this.y+e-this.height/2,this.width,this.height),i.restore())}hitCheck(t,e){return t>=this.left&&t<=this.right&&e>=this.top&&e<=this.bottom}},capsule:class extends f{constructor(t,e){if(super(t,e),this.width<this.height)throw new u("Capsule's width must be bigger then height!")}drawBaseShape(t,e,i=!0){let s=this.ctx,n={};n.x=this.x+(this.width-this.height)/2+t,n.y=this.y+e;let h={};h.x=this.x-(this.width-this.height)/2+t,h.y=this.y+e,i&&(s.beginPath(),s.arc(n.x,n.y,this.height/2,-Math.PI/2,Math.PI/2,!1),s.lineTo(h.x,h.y+this.height/2),s.arc(h.x,h.y,this.height/2,Math.PI/2,-Math.PI/2,!1),s.closePath(),s.fill()),s.beginPath(),s.arc(n.x,n.y,this.height/2,-Math.PI/2,Math.PI/2,!1),s.lineTo(h.x,h.y+this.height/2),s.arc(h.x,h.y,this.height/2,Math.PI/2,-Math.PI/2,!1),s.closePath(),s.stroke()}draw(){let t=this.ctx;t&&(t.save(),t.lineWidth=1.2,t.strokeStyle=this.strokeStyle,t.fillStyle=this.fillStyle,this.drawBaseShape(0,0),this.fillText(),t.restore())}drawDashNode(t,e){let i=this.ctx;i&&(i.save(),i.strokeStyle=this.strokeStyle,i.setLineDash([6,3]),i.lineDashOffset=0,i.lineWidth=1,this.drawBaseShape(t,e,!1),i.restore())}hitCheck(t,e){const i=this.height/2,s=this.left+i,n=this.y,h=this.right-i,o=this.y,r=(t-s)*(t-s)+(e-n)*(e-n),a=(t-h)*(t-h)+(e-o)*(e-o);return t>=this.left+i&&t<=this.right-i&&e>=this.top&&e<=this.bottom||r<=i*i||a<=i*i}nodeResizing(t,e){switch(t.direction){case"n":case"s":e=e>t.width-p?t.width-p:e;break;case"e":case"w":e=t.height>e-p?t.height+p:e}return e}},rhomb:class extends f{constructor(t,e){super(t,e)}get firstPoint(){return{x:this.x,y:this.top}}get secondPoint(){return{x:this.right,y:this.y}}get thirdPoint(){return{x:this.x,y:this.bottom}}get fourthPoint(){return{x:this.left,y:this.y}}drawBaseShape(t,e,i=!0){let s=this.ctx;i&&(s.beginPath(),s.moveTo(this.firstPoint.x+t,this.firstPoint.y+e),s.lineTo(this.secondPoint.x+t,this.secondPoint.y+e),s.lineTo(this.thirdPoint.x+t,this.thirdPoint.y+e),s.lineTo(this.fourthPoint.x+t,this.fourthPoint.y+e),s.closePath(),s.fill()),s.beginPath(),s.moveTo(this.firstPoint.x+t,this.firstPoint.y+e),s.lineTo(this.secondPoint.x+t,this.secondPoint.y+e),s.lineTo(this.thirdPoint.x+t,this.thirdPoint.y+e),s.lineTo(this.fourthPoint.x+t,this.fourthPoint.y+e),s.closePath(),s.stroke()}draw(){let t=this.ctx;t&&(t.save(),t.lineWidth=1.2,t.strokeStyle=this.strokeStyle,t.fillStyle=this.fillStyle,this.drawBaseShape(0,0),this.fillText(),t.restore())}drawDashNode(t,e){let i=this.ctx;i&&(i.save(),i.strokeStyle=this.strokeStyle,i.lineWidth=1,i.setLineDash([6,3]),i.lineDashOffset=0,this.drawBaseShape(t,e,!1),i.restore())}hitCheck(t,e){const i=(this.firstPoint.x-this.fourthPoint.x)/(this.firstPoint.y-this.fourthPoint.y),s=(this.firstPoint.x-this.secondPoint.x)/(this.firstPoint.y-this.secondPoint.y);return!(t-i*e<this.firstPoint.x-i*this.firstPoint.y||t-i*e>this.secondPoint.x-i*this.secondPoint.y||t-s*e>this.firstPoint.x-s*this.firstPoint.y||t-s*e<this.fourthPoint.x-s*this.fourthPoint.y)}},circle:class extends f{constructor(t,e){super(t,e),this.width!==this.height&&(this.height=this.width)}drawBaseShape(t,e,i=!0){let s=this.ctx,n={};n.x=this.x+t,n.y=this.y+e,i&&(s.beginPath(),s.arc(n.x,n.y,this.height/2,-Math.PI,Math.PI,!1),s.fill()),s.beginPath(),s.arc(n.x,n.y,this.height/2,-Math.PI,Math.PI,!1),s.stroke()}draw(){let t=this.ctx;t&&(t.save(),t.lineWidth=1.2,t.strokeStyle=this.strokeStyle,t.fillStyle=this.fillStyle,this.drawBaseShape(0,0),this.fillText(),t.restore())}drawDashNode(t,e){let i=this.ctx;i&&(i.save(),i.strokeStyle=this.strokeStyle,i.setLineDash([6,3]),i.lineDashOffset=0,i.lineWidth=1,this.drawBaseShape(t,e,!1),i.restore())}hitCheck(t,e){const i=this.height/2;return(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)<=i*i}}};class P{constructor(t,e){if(t.id?this.id=t.id:this.id=y.generateUUID(),!Object.hasOwnProperty.call(m,t.shape))throw new u("无法找到shape指定的图形！");this.shape=new m[t.shape](t,e),this.type=t.type,this.isOver=!1,t.index?this.index=t.index:this.index=null,this.relations=[],t.customProperties?this.customProperties=t.customProperties:this.customProperties={}}get label(){return this.shape.text.content?this.shape.text.content:null}set label(t){this.shape.text.content=t}get fontSize(){return this.shape.text.fontSize?this.shape.text.fontSize:s.defaultFont.nodeFontSize}set fontSize(t){this.shape.text.fontSize=t}get textAlign(){return this.shape.text.textAlign?this.shape.text.textAlign:"center"}set textAlign(t){this.shape.text.textAlign=t}get textBaseline(){return this.shape.text.textBaseline?this.shape.text.textBaseline:"middle"}set textBaseline(t){this.shape.text.textBaseline=t}get size(){return this.shape.width.toString()+"*"+this.shape.height.toString()}get x(){return this.shape.x}get y(){return this.shape.y}get color(){return this.shape.fillStyle}get edgeColor(){return this.shape.strokeStyle}draw(){this.shape.draw()}drawDashNode(t,e){this.shape.drawDashNode(t,e)}selectShape(){this.shape.selectShape()}showController(){this.shape.selectShape()}hitCheck(t,e){return this.shape.hitCheck(t,e)}hitCheck_Over(t,e){return this.isOver?this.shape.hitCheck_Over(t,e):this.shape.hitCheck(t,e)}hitNode(t,e){return t>=this.shape.left&&t<=this.shape.right&&e>=this.shape.top&&e<=this.shape.bottom}drawConnector(){this.shape.connector.draw()}connectorHitCheck(t,e){return this.shape.connector.hitCheck(t,e)}selectConnector(t){this.shape.connector.selectPoint(t)}}class v{constructor(t,e){this.line=t,this.ctx=e.getContext("2d")}draw(){if(this.ctx.save(),this.line.to?(this.ctx.fillStyle="rgba(255, 100, 100, 1)",this.ctx.strokeStyle="rgb(255, 0, 0, 1)"):(this.ctx.fillStyle="rgba(200, 200, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)"),this.ctx.lineWidth=.8,this.ctx.fillRect(this.line.endPoint.x-3,this.line.endPoint.y-3,6,6),this.ctx.strokeRect(this.line.endPoint.x-3,this.line.endPoint.y-3,6,6),this.line.from?(this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.strokeStyle="rgb(255, 0, 0, 1)"):(this.ctx.fillStyle="rgba(255, 255, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)"),this.ctx.fillRect(this.line.startPoint.x-3,this.line.startPoint.y-3,6,6),this.ctx.strokeRect(this.line.startPoint.x-3,this.line.startPoint.y-3,6,6),this.ctx.restore(),this.line.inflexionPoint&&this.line.inflexionPoint.length>1){this.ctx.save(),this.ctx.fillStyle="rgba(200, 200, 255, 1)",this.ctx.strokeStyle="rgb(100, 150, 255, 1)",this.ctx.lineWidth=.8;for(let t=0;t<this.line.inflexionPoint.length-1;t++){const e=this.line.inflexionPoint[t],i=this.line.inflexionPoint[t+1],s={x:(e.x+i.x)/2,y:(e.y+i.y)/2};s.x&&s.y&&(this.ctx.fillRect(s.x-2.5,s.y-2.5,5,5),this.ctx.strokeRect(s.x-2.5,s.y-2.5,5,5))}this.ctx.restore()}}hitCheck(t,e){if(t>=this.line.startPoint.x-4&&t<=this.line.startPoint.x+4&&e>=this.line.startPoint.y-4&&e<=this.line.startPoint.y+4)return{operation:s.lineOperations.startPointChange,position:this.line.startPoint};if(t>=this.line.endPoint.x-4&&t<=this.line.endPoint.x+4&&e>=this.line.endPoint.y-4&&e<=this.line.endPoint.y+4)return{operation:s.lineOperations.endPointChange,position:this.line.endPoint};if(this.line.inflexionPoint&&this.line.inflexionPoint.length>1)for(let i=0;i<this.line.inflexionPoint.length-1;i++){const n=this.line.inflexionPoint[i],h=this.line.inflexionPoint[i+1];let o={};if(n.x===h.x?(o.x=n.x,o.y=(n.y+h.y)/2):n.y===h.y&&(o.y=n.y,o.x=(n.x+h.x)/2),o.x&&o.y&&t>=o.x-4&&t<=o.x+4&&e>=o.y-4&&e<=o.y+4){let t=null,e=null;t=i-1<0?this.secondPoint:this.line.inflexionPoint[i-1],e=i+2>=this.line.inflexionPoint.length?this.endPoint:this.line.inflexionPoint[i+2];const r=[];return r.push(t),r.push(n),r.push(o),r.push(h),r.push(e),{operation:s.lineOperations.middlePathChange,points:r}}}return!1}}class g extends d{constructor(t,e){if(super(t,e),this.start=null,this.end=null,this.from=null,this.to=null,this.fromConOrder=null,this.toConOrder=null,t.text?this.text=t.text:this.text={content:null,fontSize:null},t.from&&t.fromConOrder)this.from=t.from,this.fromConOrder=t.fromConOrder;else{if(!t.startPoint)throw new u("连线缺少起点信息！");this.start={},this.start.x=t.startPoint.x,this.start.y=t.startPoint.y}if(t.to&&t.toConOrder)this.to=t.to,this.toConOrder=t.toConOrder;else{if(!t.endPoint)throw new u("连线缺少终点信息！");this.end={},this.end.x=t.endPoint.x,this.end.y=t.endPoint.y}this.controller=new v(this,e)}get startPoint(){return this.start?this.start:this.from&&1===this.fromConOrder?this.from.shape.connector.firstPoint:this.from&&2===this.fromConOrder?this.from.shape.connector.secondPoint:this.from&&3===this.fromConOrder?this.from.shape.connector.thirdPoint:this.from&&4===this.fromConOrder?this.from.shape.connector.forthPoint:void 0}set startPoint(t){this.start=t}get endPoint(){return this.end?this.end:this.to&&1===this.toConOrder?this.to.shape.connector.firstPoint:this.to&&2===this.toConOrder?this.to.shape.connector.secondPoint:this.to&&3===this.toConOrder?this.to.shape.connector.thirdPoint:this.to&&4===this.toConOrder?this.to.shape.connector.forthPoint:void 0}set endPoint(t){this.end=t}fillText(t,e){if(!t&&this.text&&this.text.content){this.ctx.lineWidth=.5,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.text.fontSize?this.ctx.font=this.text.fontSize+" "+s.defaultFont.fontFamily:(this.ctx.font=s.defaultFont.relationFontSize+" "+s.defaultFont.fontFamily,this.text.fontSize=s.defaultFont.relationFontSize),this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=parseInt((this.text.fontSize||s.defaultFont.relationFontSize).replace("px","")),i=this.ctx.measureText(this.text.content).width;this.ctx.clearRect(e.x-i/2-1,e.y-t/2-1,i+2,t+2),this.ctx.fillText(this.text.content,e.x,e.y)}}}const C=10*s.ratio,E=C*Math.sin(25*Math.PI/180)/Math.sin(60*Math.PI/180);var w={drawCommonArrow(t,e,i,s){t.beginPath(),t.moveTo(s.x,s.y);let n,h={},o={},r={};n=0===e&&i>=0?Math.PI/2:0===e&&i<0?-Math.PI/2:0===i&&e<0?Math.atan(i/e)-Math.PI:0===i&&e>0?Math.atan(i/e):e<0?Math.atan(i/e)-Math.PI:Math.atan(i/e),h.x=s.x-C*Math.cos(n-25*Math.PI/180),h.y=s.y-C*Math.sin(n-25*Math.PI/180),o.x=h.x+E*Math.cos(n-60*Math.PI/180),o.y=h.y+E*Math.sin(n-60*Math.PI/180),r.x=s.x-C*Math.cos(n+25*Math.PI/180),r.y=s.y-C*Math.sin(n+25*Math.PI/180),t.lineTo(h.x,h.y),t.lineTo(o.x,o.y),t.lineTo(r.x,r.y),t.fill()}};const k=25,b=10,S=5,L={north:1,northEast:2,east:3,southEast:4,south:5,southWest:6,west:7,northWest:8};function O(t,e){let i={};"x"===t&&e.x<2*k?([i.x,i.y]=[2===this.startPoint.order?this.startPoint.x+e.x/2:this.startPoint.x-e.x/2,this.startPoint.y],this.inflexionPoint.push(i)):"y"===t&&e.y<2*k?([i.x,i.y]=[this.startPoint.x,1===this.startPoint.order?this.startPoint.y-e.y/2:this.startPoint.y+e.y/2],this.inflexionPoint.push(i)):i=R(this.startPoint,this.inflexionPoint),t="y"===t?"x":"y",N(this.to,i,this.endPoint,t,this.inflexionPoint)}function z(t,e){let i=D(this.startPoint,this.endPoint,this.from,this.to,e,t),s=M(this.from,this.startPoint,i,this.inflexionPoint);this.inflexionPoint.push(i),s="y"===s?"x":"y",N(this.to,i,this.endPoint,s,this.inflexionPoint)}function M(t,e,i,s){let n=I(i,t),h=T(e.order),o=e.order%2==1?"y":"x",r=!1,a=e;for(A(h.orientation,n.orientation)<2?(o=_(o,a,i,s),r=!0):(a=R(e,s),o="y"===o?"x":"y");!r;){let e=I(a,t),h=A(e.orientation,n.orientation);e.orientation%2==1?h>1&&h<4?(o=_(o,a,i,s),r=!0):4===h&&(a=F(o,a,i,t,s),o="y"===o?"x":"y"):e.orientation%2==0&&(o=_(o,a,i,s),r=!0)}return o}function R(t,e){let i={};switch(t.order){case 1:[i.x,i.y]=[t.x,t.y-k];break;case 2:[i.x,i.y]=[t.x+k,t.y];break;case 3:[i.x,i.y]=[t.x,t.y+k];break;case 4:[i.x,i.y]=[t.x-k,t.y]}return e.push(i),i}function D(t,e,i,s,n,h){let o={},r=0,a=i.shape.right>s.shape.right?i.shape.right:s.shape.right,l=i.shape.left<s.shape.left?i.shape.left:s.shape.left,c=i.shape.top<s.shape.top?i.shape.top:s.shape.top,d=i.shape.bottom>s.shape.bottom?i.shape.bottom:s.shape.bottom;switch(h){case 1:switch(t.order){case 1:r=n.x>2*k?k:n.x/2,[o.x,o.y]=[e.x>t.x?i.shape.right+r:i.shape.left-r,t.y-k];break;case 2:r=n.y>2*k?k:n.y/2,[o.x,o.y]=[t.x+k,e.y>t.y?i.shape.bottom+r:i.shape.top-r];break;case 3:r=n.x>2*k?k:n.x/2,[o.x,o.y]=[e.x>t.x?i.shape.right+r:i.shape.left-r,t.y+k];break;case 4:r=n.y>2*k?k:n.y/2,[o.x,o.y]=[t.x-k,e.y>t.y?i.shape.bottom+r:i.shape.top-r]}break;case 2:switch(t.order){case 1:r=n.y>2*k?k:n.y/2,[o.x,o.y]=[e.x>t.x?i.shape.right+k:i.shape.left-k,i.shape.bottom+r];break;case 2:r=n.x>2*k?k:n.x/2,[o.x,o.y]=[i.shape.left-r,e.y>t.y?i.shape.bottom+k:i.shape.top-k];break;case 3:r=n.y>2*k?k:n.y/2,[o.x,o.y]=[e.x>t.x?i.shape.right+k:i.shape.left-k,i.shape.top-r];break;case 4:r=n.x>2*k?k:n.x/2,[o.x,o.y]=[i.shape.right+r,e.y>t.y?i.shape.bottom+k:i.shape.top-k]}break;case 3:switch(t.order){case 1:[o.x,o.y]=[e.x>t.x?a+k:l-k,c-k];break;case 2:[o.x,o.y]=[a+k,e.y>t.y?d+k:c-k];break;case 3:[o.x,o.y]=[e.x>t.x?a+k:l-k,d+k];break;case 4:[o.x,o.y]=[l-k,e.y>t.y?d+k:c-k]}break;case 4:switch(t.order){case 1:[o.x,o.y]=[t.x,c-k];break;case 2:[o.x,o.y]=[a+k,t.y];break;case 3:[o.x,o.y]=[t.x,d+k];break;case 4:[o.x,o.y]=[l-k,t.y]}break;case 5:1===t.order&&4===e.order||4===t.order&&1===e.order?[o.x,o.y]=[i.shape.left-k,i.shape.top-k]:1===t.order&&2===e.order||2===t.order&&1===e.order?[o.x,o.y]=[i.shape.right+k,i.shape.top-k]:3===t.order&&4===e.order||4===t.order&&3===e.order?[o.x,o.y]=[i.shape.left-k,i.shape.bottom+k]:(3===t.order&&2===e.order||2===t.order&&3===e.order)&&([o.x,o.y]=[i.shape.right+k,i.shape.bottom+k])}return o}function N(t,e,i,s,n){let h=T(i.order),o=!1,r=e;for(;!o;){let e=I(r,t),a=A(e.orientation,h.orientation);e.orientation%2==1?0===a?(_(s,r,i,n),o=!0):4===a?(r=F(s,r,i,t,n,!1),s="y"===s?"x":"y"):(r=F(s,r,i,t,n),s="y"===s?"x":"y"):e.orientation%2==0&&(a<3?(_(s,r,i,n),o=!0):(r=F(s,r,i,t,n),s="y"===s?"x":"y"))}}function _(t,e,i,s){let n={};return"x"===t&&e.y!==i.y?([n.x,n.y]=[i.x,e.y],s.length>0&&s[s.length-1].x===n.x&&s[s.length-1].y===n.y?s.pop():s.push(n),t="y"===t?"x":"y"):"y"===t&&e.x!==i.x&&([n.x,n.y]=[e.x,i.y],s.length>0&&s[s.length-1].x===n.x&&s[s.length-1].y===n.y?s.pop():s.push(n),t="y"===t?"x":"y"),t}function F(t,e,i,s,n,h=!0){let o={};return"x"===t?i.x<e.x^h?[o.x,o.y]=[s.shape.right+k,e.y]:[o.x,o.y]=[s.shape.left-k,e.y]:i.y<e.y^h?[o.x,o.y]=[e.x,s.shape.bottom+k]:[o.x,o.y]=[e.x,s.shape.top-k],n.push(o),o}function T(t){let e={distanceX:0,distanceY:0};switch(t){case 1:e.orientation=L.north;break;case 2:e.orientation=L.east;break;case 3:e.orientation=L.south;break;case 4:e.orientation=L.west}return e}function I(t,e){let i={};const s=e.shape.top>t.y,n=e.shape.bottom<t.y,h=e.shape.left>t.x,o=e.shape.right<t.x;return i.orientation=s&&h?L.northWest:s&&o?L.northEast:!s||h||o?n&&h?L.southWest:n&&o?L.southEast:!n||h||o?s||n||!h?s||n||!o?null:L.east:L.west:L.south:L.north,i}function A(t,e){let i=Math.abs(e-t);return i>4&&(i=8-i),i}const j=5;const Y={polyline:class extends g{constructor(t,e){super(t,e),t.inflexionPoint?this.inflexionPoint=y.deepClone(t.inflexionPoint):this.inflexionPoint=null}get textPoint(){if(this.inflexionPoint&&this.inflexionPoint.length>0){let t=0,e=0,i=[],s={},n={};if(s.first=this.startPoint,s.second=this.inflexionPoint[0],s.distance=s.first.x===s.second.x?Math.abs(s.first.y-s.second.y):Math.abs(s.first.x-s.second.x),i.push(s),t+=s.distance,this.inflexionPoint.length>1)for(let e=0;e<this.inflexionPoint.length-1;e++){let s={};s.first=this.inflexionPoint[e],s.second=this.inflexionPoint[e+1],s.distance=s.first.x===s.second.x?Math.abs(s.first.y-s.second.y):Math.abs(s.first.x-s.second.x),i.push(s),t+=s.distance}n.first=this.inflexionPoint[this.inflexionPoint.length-1],n.second=this.endPoint,n.distance=n.first.x===n.second.x?Math.abs(n.first.y-n.second.y):Math.abs(n.first.x-n.second.x),i.push(n),t+=n.distance;for(const s of i)if((e+=s.distance)>=t/2){if(s.first.x===s.second.x)return{x:s.first.x,y:s.second.y>s.first.y?s.second.y-e+t/2:s.second.y+e-t/2};if(s.first.y===s.second.y)return{x:s.second.x>s.first.x?s.second.x-e+t/2:s.second.x+e-t/2,y:s.second.y}}}else{if(this.startPoint.x===this.endPoint.x)return{x:this.startPoint.x,y:(this.startPoint.y+this.endPoint.y)/2};if(this.startPoint.y===this.endPoint.y)return{x:(this.startPoint.x+this.endPoint.x)/2,y:this.startPoint.y}}}createPath(){if(this.inflexionPoint=[],this.from||this.to){let t=!1;if(this.from&&(t=this.from.hitNode(this.endPoint.x,this.endPoint.y)),this.to&&(t=t||this.to.hitNode(this.startPoint.x,this.startPoint.y)),t&&this.from!==this.to)if(this.from){let t=this.startPoint.order%2==1?"y":"x";!this.to||this.to&&(this.startPoint.order+this.endPoint.order)%2==1?_(t,this.startPoint,this.endPoint,this.inflexionPoint):function(t,e,i,s){let n={},h={};"y"===t&&e.x!==i.x?([n.x,n.y]=[e.x,(i.y+e.y)/2],s.push(n),[h.x,h.y]=[i.x,n.y],s.push(h)):"x"===t&&e.y!==i.y&&([n.x,n.y]=[(e.x+e.x)/2,i.y],s.push(n),[h.x,h.y]=[n.x,i.y],s.push(h))}(t,this.startPoint,this.endPoint,this.inflexionPoint)}else _(this.endPoint.order%2==1?"y":"x",this.endPoint,this.startPoint,this.inflexionPoint);else if(this.to)if(this.from)if(this.from===this.to)z.call(this,4,{x:0,y:0});else{let t=T(this.startPoint.order),e=I(this.startPoint,this.to),i=I(this.endPoint,this.from),s=T(this.endPoint.order),n=A(t.orientation,i.orientation),h=A(e.orientation,s.orientation),o=Math.abs(this.startPoint.order-this.endPoint.order),r=function(t,e){let i={};return t.shape.center.x<e.shape.center.x?i.x=e.shape.left-t.shape.right:i.x=t.shape.left-e.shape.right,t.shape.center.y<e.shape.center.y?i.y=e.shape.top-t.shape.bottom:i.y=t.shape.top-e.shape.bottom,i}(this.from,this.to),a=this.startPoint.order%2==1?"y":"x";switch(o){case 0:4===n?z.call(this,2,r):4===h?O.call(this,a,r):"y"===a?(Math.abs(this.endPoint.x-this.from.shape.left)<b||Math.abs(this.endPoint.x-this.from.shape.right)<b)&&r.y>b&&3===n?z.call(this,2,r):z.call(this,4,r):(Math.abs(this.endPoint.y-this.from.shape.top)<b||Math.abs(this.endPoint.y-this.from.shape.bottom)<b)&&r.x>b&&3===n?z.call(this,2,r):z.call(this,4,r);break;case 1:case 3:if(n<2&&h<2){let t={};[t.x,t.y]="y"===a?[this.startPoint.x,this.endPoint.y]:[this.endPoint.x,this.startPoint.y],this.inflexionPoint.push(t)}else n<2&&2===h?O.call(this,a,r):n<2&&3===h?"y"===a&&r.y<b||"x"===a&&r.x<b?z.call(this,4,r):O.call(this,a,r):n<2&&4===h?z.call(this,4,r):2===n&&h>=2?z.call(this,3,r):2===n&&h<2?z.call(this,1,r):3===n&&h>=2?z.call(this,3,r):3===n&&h<2?"y"===a&&r.x>b||"x"===a&&r.y>b?z.call(this,1,r):"y"===a&&r.y>b||"x"===a&&r.x>b?z.call(this,2,r):z.call(this,5,r):4===n&&((1===this.endPoint.order&&this.endPoint.y>this.startPoint.y||3===this.endPoint.order&&this.endPoint.y<this.startPoint.y)&&r.x>b||(2===this.endPoint.order&&this.endPoint.x<this.startPoint.x||4===this.endPoint.order&&this.endPoint.x>this.startPoint.x)&&r.y>b?z.call(this,2,r):z.call(this,5,r));break;case 2:if(n<2&&h<2)O.call(this,a,r);else if(n<4)if("y"===a&&r.x>b||"x"===a&&r.y>b)z.call(this,1,r);else if("y"===a&&r.y>b||"x"===a&&r.x>b){let t=D(this.startPoint,this.endPoint,this.from,this.to,r,2);"y"!==a||this.startPoint.x<this.endPoint.x^t.x<this.endPoint.x?z.call(this,3,r):(a=M(this.from,this.startPoint,t,this.inflexionPoint),this.inflexionPoint.push(t),a="y"===a?"x":"y",N(this.to,t,this.endPoint,a,this.inflexionPoint))}else z.call(this,3,r);else z.call(this,3,r)}}else M(this.to,this.endPoint,this.startPoint,this.inflexionPoint),this.inflexionPoint&&this.inflexionPoint.length>1&&this.inflexionPoint.reverse();else M(this.from,this.startPoint,this.endPoint,this.inflexionPoint)}else if(this.startPoint.x!==this.endPoint.x&&this.startPoint.y!==this.endPoint.y){let t={};[t.x,t.y]=[this.startPoint.x,this.endPoint.y],this.inflexionPoint.push(t)}}drawLine(t,e){const i=this.ctx;if(!i)return;i.save(),i.lineWidth=t,i.strokeStyle=this.strokeStyle,i.fillStyle="rgba(100, 100, 100, 1)",e&&(i.setLineDash([6,3]),i.lineDashOffset=0),i.beginPath(),i.moveTo(this.startPoint.x,this.startPoint.y),this.inflexionPoint&&this.inflexionPoint.map(t=>{i.lineTo(t.x,t.y)}),i.lineTo(this.endPoint.x,this.endPoint.y),i.stroke();let s=null;this.inflexionPoint&&this.inflexionPoint.length>0?(s=this.inflexionPoint.pop(),this.inflexionPoint.push(s)):s=this.startPoint,w.drawCommonArrow(i,this.endPoint.x-s.x,this.endPoint.y-s.y,this.endPoint),this.fillText(e,this.textPoint),i.restore()}hitCheck(t,e){let i=!1,s=this.startPoint;this.inflexionPoint?this.inflexionPoint.push(this.endPoint):(this.inflexionPoint=[],this.inflexionPoint.push(this.endPoint));for(const n of this.inflexionPoint){if(s.x===n.x){if(t>=s.x-S&&t<=s.x+S&&e>=(s.y>n.y?n.y:s.y)&&e<=(s.y<n.y?n.y:s.y)){i=!0;break}}else if(s.y===n.y&&e>=s.y-S&&e<=s.y+S&&t>=(s.x>n.x?n.x:s.x)&&t<=(s.x<n.x?n.x:s.x)){i=!0;break}s=n}return this.inflexionPoint.pop(),0===this.inflexionPoint.length&&(this.inflexionPoint=null),i}},straightline:class extends g{constructor(t,e){super(t,e)}get textPoint(){return{x:(this.startPoint.x+this.endPoint.x)/2,y:(this.startPoint.y+this.endPoint.y)/2}}createPath(){this.inflexionPoint=[]}drawLine(t,e){const i=this.ctx;i&&(i.save(),i.lineWidth=t,i.strokeStyle=this.strokeStyle,i.fillStyle="rgba(100, 100, 100, 1)",e&&(i.setLineDash([6,3]),i.lineDashOffset=0),i.beginPath(),i.moveTo(this.startPoint.x,this.startPoint.y),i.lineTo(this.endPoint.x,this.endPoint.y),i.stroke(),w.drawCommonArrow(i,this.endPoint.x-this.startPoint.x,this.endPoint.y-this.startPoint.y,this.endPoint),this.fillText(e,this.textPoint),i.restore())}hitCheck(t,e){const i=this.startPoint.x,s=this.startPoint.y,n=this.endPoint.x,h=this.endPoint.y;if(s===h&&e>=s-j&&e<=s+j&&t>=(i>n?n:i)&&t<=(i<n?n:i))return!0;if(i===n&&t>=i-j&&t<=i+j&&e>=(s>h?h:s)&&e<=(s<h?h:s))return!0;const o=(s-h)/(i-n),r=-1/o,a=e-r*t,l=(a-(s-o*i))/(o-r),c=r*l+a;return l>=(i>n?n:i)&&l<=(i<n?n:i)&&(t-l)*(t-l)+(e-c)*(e-c)<=j*j}}};class X{constructor(t,e){this.line=null,Object.hasOwnProperty.call(Y,t.lineModel)?(this.line=new Y[t.lineModel](t,e),this.lineModelText=t.lineModel):(this.line=new Y.polyline(t,e),this.lineModelText="polyline"),t.id?this.id=t.id:this.id=y.generateUUID(),t.index?this.index=t.index:this.index=null,t.customProperties?this.customProperties=t.customProperties:this.customProperties={}}get startPoint(){return this.line.startPoint}set startPoint(t){this.line.startPoint=t}get endPoint(){return this.line.endPoint}set endPoint(t){this.line.endPoint=t}get textPoint(){return this.line.textPoint}get label(){return this.line.text.content?this.line.text.content:null}set label(t){this.line.text.content=t}get fontSize(){return this.line.text.fontSize?this.line.text.fontSize:s.defaultFont.relationFontSize}set fontSize(t){this.line.text.fontSize=t}get source(){return this.line.from?this.line.from.id:null}get target(){return this.line.to?this.line.to.id:null}get from(){return this.line.from}set from(t){this.line.from=t}get to(){return this.line.to}set to(t){this.line.to=t}get fromConOrder(){return this.line.fromConOrder}set fromConOrder(t){this.line.fromConOrder=t}get toConOrder(){return this.line.toConOrder}set toConOrder(t){this.line.toConOrder=t}get lineModel(){return this.lineModelText}set lineModel(t){this.lineModelText=t;let e={strokeStyle:this.line.strokeStyle,text:{content:this.label,fontSize:this.fontSize},fromConOrder:this.fromConOrder,toConOrder:this.toConOrder,startPoint:this.startPoint,endPoint:this.endPoint,from:this.from,to:this.to};Object.hasOwnProperty.call(Y,this.lineModelText)?this.line=new Y[this.lineModelText](e,this.line.canvas):(this.line=new Y.polyline(params,this.line.canvas),this.lineModelText="polyline"),this.line.createPath()}createPath(){this.line.createPath()}draw(){this.line.drawLine(.7)}drawDashLine(t){this.line.drawLine(.7,!0),this.line.ctx.save(),this.line.to&&t===s.lineOperations.endPointChange&&(this.line.ctx.strokeStyle="rgb(255, 50, 50, 1)",this.line.ctx.strokeRect(this.endPoint.x-5,this.endPoint.y-5,10,10)),this.line.from&&t===s.lineOperations.startPointChange&&(this.line.ctx.strokeStyle="rgb(255, 50, 50, 1)",this.line.ctx.strokeRect(this.startPoint.x-5,this.startPoint.y-5,10,10)),this.line.ctx.restore()}showController(){this.line.controller.draw()}hitCheck(t,e){return this.line.hitCheck(t,e)}}class B{constructor(t){this.nodes=[],this.relations=[],this.initialArea(),this.ctx=t.getContext("2d")}initialArea(){this.area={top:1/0,left:1/0,bottom:0,right:0,isInitial:!1}}draw(){this.initialArea();for(const t of this.nodes)t.shape.top<this.area.top&&(this.area.top=t.shape.top),t.shape.left<this.area.left&&(this.area.left=t.shape.left),t.shape.bottom>this.area.bottom&&(this.area.bottom=t.shape.bottom),t.shape.right>this.area.right&&(this.area.right=t.shape.right);this.ctx.save(),this.ctx.lineWidth=.6,this.ctx.strokeStyle="rgb(255, 0, 255)",this.ctx.strokeRect(this.area.left-10,this.area.top-10,this.area.right-this.area.left+20,this.area.bottom-this.area.top+20),this.ctx.restore()}drawDashGroup(t,e){for(const i of this.nodes)i.drawDashNode(t,e)}}let W,H,U,G,K;Event instanceof Function?(W=new Event("selectedElement"),H=new Event("canvasClick"),U=new Event("save"),G=new Event("undo"),K=new Event("redo")):(W=document.createEvent("Event"),H=document.createEvent("Event"),U=document.createEvent("Event"),G=document.createEvent("Event"),K=document.createEvent("Event"),W.initEvent("selectedElement",!1,!1),H.initEvent("canvasClick",!1,!1),U.initEvent("save",!1,!1),G.initEvent("undo",!1,!1),K.initEvent("redo",!1,!1));var J={selectedElement:W,click:H,save:U,undo:G,redo:K};const q={saveAll(){this.moveCache={},this.moveCache.x=0,this.moveCache.y=0,this.moveCache.imgData=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)},saveStateForConnector(t){this.connectorCache=t.shape.connector.saveState()},saveStateForLine_Right(t,e){t.y=e.shape.center.y,this.start_x={x:t.x-this.selectedElement.shape.width/2-15+this.offset_X,y:t.y},this.end_x={x:e.shape.center.x+e.shape.width/2+15,y:t.y}},saveStateForLine_Left(t,e){t.y=e.shape.center.y,this.start_x={x:e.shape.center.x-e.shape.width/2-15,y:t.y},this.end_x={x:t.x+this.selectedElement.shape.width/2+15+this.offset_X,y:t.y}},saveStateForLine_Top(t,e){t.x=e.shape.center.x,this.start_y={x:t.x,y:e.shape.center.y-e.shape.height/2-15},this.end_y={x:t.x,y:t.y+this.selectedElement.shape.height/2+15+this.offset_Y}},saveStateForLine_Bottom(t,e){t.x=e.shape.center.x,this.start_y={x:t.x,y:t.y-this.selectedElement.shape.height/2-15+this.offset_Y},this.end_y={x:t.x,y:e.shape.center.y+e.shape.height/2+15}},rollbackForMoving(){let t=this.ctx;this.moveCache&&t.putImageData(this.moveCache.imgData,this.moveCache.x,this.moveCache.y)},rollbackConnector(){if(this.connectorCache){for(const t of this.connectorCache)this.ctx.putImageData(t.imgData,t.x,t.y);this.connectorCache=null}},createNode(t,e=!1){let i=new P(t,this.canvas);return i.index=this.indexMark,this.indexMark++,e||(i.draw(),this.nodes.push(i),this.elements.push(i),this.elementDict[i.id]=i),i},createRelation(t){let e=new X(t,this.canvas);return e.index=this.indexMark,this.indexMark++,e.line.inflexionPoint||e.createPath(),e.from&&e.from.relations.push(e),e.to&&e.to.relations.push(e),this.relations.push(e),this.elements.push(e),this.elementDict[e.id]=e,e},moveShape(t,e){if(this.selectedElement instanceof P){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.selectedElement.shape.x=this.selectedElement.shape.x+t,this.selectedElement.shape.y=this.selectedElement.shape.y+e,this.selectedElement.index=this.indexMark,this.indexMark++;for(const t of this.selectedElement.relations)t.createPath(),t.index=this.indexMark,this.indexMark++;this.elements=this.elements.sort(function(t,e){return t.index-e.index}),this.elements.map(t=>{t.draw()}),this.selectedElement.drawConnector(),this.selectedElement.showController()}},moveGroup(t,e){if(this.selectedElement instanceof B){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.selectedElement.nodes=this.selectedElement.nodes.sort(function(t,e){return t.index-e.index});for(const i of this.selectedElement.nodes)i.shape.x=i.shape.x+t,i.shape.y=i.shape.y+e,i.index=this.indexMark,this.indexMark++;for(const t of this.selectedElement.nodes)for(const e of t.relations)-1==this.selectedElement.relations.indexOf(e)&&(e.createPath(),e.index=this.indexMark,this.indexMark++);for(const i of this.selectedElement.relations){if(i.line.inflexionPoint)for(const s of i.line.inflexionPoint)s.x=s.x+t,s.y=s.y+e;i.index=this.indexMark,this.indexMark++}this.elements=this.elements.sort(function(t,e){return t.index-e.index}),this.elements.map(t=>{t.draw()});for(const t of this.selectedElement.nodes)t.showController();this.selectedElement.draw()}},reload(t=!0){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.elements=this.elements.sort(function(t,e){return t.index-e.index}),this.elements.map(t=>{t.draw()}),this.selectedElement&&t)if(this.selectedElement instanceof B){for(const t of this.selectedElement.nodes)t.showController();this.selectedElement.draw()}else this.selectedElement.showController()},undo(){let t=null;if(this.stepMark>0){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),t=this.stepCache[--this.stepMark];let e=J.undo;this.canvas.dispatchEvent(e),this.load(t,!0)}},redo(){let t=null;if(this.stepMark<this.stepCache.length-1){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),t=this.stepCache[++this.stepMark];let e=J.redo;this.canvas.dispatchEvent(e),this.load(t,!0)}},deleteEle(){if(this.selectedElement instanceof P){if(-1==this.nodes.indexOf(this.selectedElement))return;this.nodes.splice(this.nodes.indexOf(this.selectedElement),1),this.elements.splice(this.elements.indexOf(this.selectedElement),1);for(const t of this.selectedElement.relations)t.from===this.selectedElement&&(t.startPoint={x:t.startPoint.x,y:t.startPoint.y},t.from=null),t.to===this.selectedElement&&(t.endPoint={x:t.endPoint.x,y:t.endPoint.y},t.to=null)}else{if(!(this.selectedElement instanceof X))return;if(-1==this.relations.indexOf(this.selectedElement))return;this.relations.splice(this.relations.findIndex(t=>t===this.selectedElement),1),this.elements.splice(this.elements.findIndex(t=>t===this.selectedElement),1),this.selectedElement.from&&this.selectedElement.from.relations.splice(this.selectedElement.from.relations.findIndex(t=>t===this.selectedElement),1),this.selectedElement.to&&this.selectedElement.to!==this.selectedElement.from&&this.selectedElement.to.relations.splice(this.selectedElement.to.relations.findIndex(t=>t===this.selectedElement),1)}Reflect.deleteProperty(this.elementDict,this.selectedElement.id),this.selectedElement=null,q.reload.call(this),q.saveStepCache.call(this)},moveShapeOrGroup(t){this.selectedElement&&this.selectedElement instanceof P?q.moveShape.call(this,t.x,t.y):this.selectedElement&&this.selectedElement instanceof B&&q.moveGroup.call(this,t.x,t.y)},saveStepCache(){for(this.stepMark<this.stepCache.length-1&&this.stepCache.splice(this.stepMark+1,this.stepCache.length-this.stepMark-1),this.stepCache.push(V(this.elements));this.stepCache.length>100;)this.stepCache.pop();this.stepMark=this.stepCache.length-1},save(){let t=J.save;t.data={},t.data.dict=this.elementDict,t.data.elements=V(this.elements),this.canvas.dispatchEvent(t),t.data=null},changeTextAlign(t){this.selectedElement instanceof P&&(this.selectedElement.shape.text.textAlign=t,q.reload.call(this),q.saveStepCache.call(this))},changeBaseline(t){this.selectedElement instanceof P&&(this.selectedElement.shape.text.textBaseline=t,q.reload.call(this),q.saveStepCache.call(this))},outPut:function(t){return V(t)},outPutUnit:function(t){return Z(t)}};var Q=q;function V(t){let e={},i=[],s=[];for(const e of t){let t=Z(e);t&&t.isNode?i.push(t):t&&t.isLine&&s.push(t)}return e.nodes=i,e.relations=s,e}function Z(t){if(t instanceof P){return{id:t.id,type:s.elementTypes.node,shape:t.shape.type,index:t.index,x:t.shape.x,y:t.shape.y,size:t.shape.width.toString()+"*"+t.shape.height.toString(),label:t.label,fontSize:t.fontSize,textAlign:t.textAlign,textBaseline:t.textBaseline,color:t.shape.fillStyle,edgeColor:t.shape.strokeStyle,customProperties:y.deepClone(t.customProperties),isNode:!0,isLine:!1}}if(t instanceof X){return{id:t.id,type:s.elementTypes.relation,index:t.index,source:t.source,fromConOrder:t.fromConOrder,target:t.target,toConOrder:t.toConOrder,inflexionPoint:y.deepClone(t.line.inflexionPoint),label:t.label,fontSize:t.fontSize,color:t.line.strokeStyle,startPoint:y.deepClone(t.line.start),endPoint:y.deepClone(t.line.end),lineModel:t.lineModel,customProperties:y.deepClone(t.customProperties),isNode:!1,isLine:!0}}return t instanceof B?V(t.nodes.concat(t.relations)):null}var $={mouseDownEventHandler:function(t){let e=!1,i=!1,n=!1,h=[];if(this.clickPoint.x=t.offsetX*s.ratio,this.clickPoint.y=t.offsetY*s.ratio,this.moveCache=null,this.selectedElement)if(this.selectedElement instanceof X){if(e=this.selectedElement.line.controller.hitCheck(this.clickPoint.x,this.clickPoint.y)){this.lineCache={},this.currentLine=this.selectedElement,this.lineCache.operation=e.operation,e.operation===s.lineOperations.startPointChange||e.operation===s.lineOperations.endPointChange?(this.lineCache.from=this.currentLine.from,this.lineCache.fromConOrder=this.currentLine.fromConOrder,this.lineCache.to=this.currentLine.to,this.lineCache.toConOrder=this.currentLine.toConOrder,this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.changeStartOrEndOfLine)):(this.lineCache.points=e.points,this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.drawCurrentDashLine)),this.addEventListener("mouseup",this.drawLine),this.addEventListener("mouseleave",this.mouseLeaveHandler);let t=J.click;return t.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(t),void(t.element=null)}}else if(this.selectedElement instanceof P&&(i=this.selectedElement.shape.controller.hitCheck(this.clickPoint.x,this.clickPoint.y))){this.nodeResizeCache={},this.nodeResizeCache.direction=i.order,this.nodeResizeCache.x=this.selectedElement.shape.center.x,this.nodeResizeCache.y=this.selectedElement.shape.center.y,this.nodeResizeCache.width=this.selectedElement.shape.width,this.nodeResizeCache.height=this.selectedElement.shape.height;let t=J.click;return t.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(t),t.element=null,this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.nodeResizing),this.addEventListener("mouseup",this.nodeResized),void this.addEventListener("mouseleave",this.mouseLeaveHandler)}if(this.mouseOverNode&&!e&&(n=this.mouseOverNode.connectorHitCheck(this.clickPoint.x,this.clickPoint.y)),n){this.startPoint={},this.startPoint.from=this.mouseOverNode,this.startPoint.order=n;let t=J.click;t.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(t),t.element=null,this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.drawNewDashLine),this.addEventListener("mouseup",this.drawLine),this.addEventListener("mouseleave",this.mouseLeaveHandler)}else{for(const t of this.elements)t.hitCheck(this.clickPoint.x,this.clickPoint.y)&&h.push(t);if(h.sort(function(t,e){return t.index-e.index}),0===h.length){this.selectedElement=null,t.ctrlKey?(this.canvas.style.cursor="crosshair",this.composeModel=!0):this.canvas.style.cursor="-webkit-grabbing",this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.moveCanvasOrCompose),this.addEventListener("mouseup",this.moveCanvasComplete),this.addEventListener("mouseleave",this.canvasMoveLeave);let e=J.click;e.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(e),e.element=null}else{let t=h.pop();this.selectedElement&&this.selectedElement instanceof B&&(-1!==this.selectedElement.nodes.indexOf(t)||-1!==this.selectedElement.relations.indexOf(t))||(this.selectedElement=t),(this.selectedElement instanceof P||this.selectedElement instanceof B)&&(this.removeEventListener("mousemove",this.mouseOverSelect),this.addEventListener("mousemove",this.drawDashShape),this.addEventListener("mouseup",this.moveSelectedElement),this.addEventListener("mouseleave",this.mouseLeaveHandler));let e=J.selectedElement;e.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(e),e.element=null;let i=J.click;i.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(i),i.element=null}Q.reload.call(this),this.mouseOverNode&&this.mouseOverNode.drawConnector()}},changeStartOrEndOfLine:function(t){let e={},i=[];e.x=t.offsetX*s.ratio,e.y=t.offsetY*s.ratio,this.mouseOverNode&&(this.mouseOverNode.isOver=!1,this.mouseOverNode=null,Q.reload.call(this));for(const t of this.nodes)t.shape.anchor.draw();for(const e of this.nodes){const n=e.shape.connector.connectCheck(t.offsetX*s.ratio,t.offsetY*s.ratio);if(n){let t={};t.node=e,t.distance=n.distance,t.order=n.order,i.push(t)}}if(this.lineCache.operation===s.lineOperations.startPointChange)if(i.length>0){i.sort(ht);const t=i.pop();this.currentLine.from=t.node,this.currentLine.fromConOrder=t.order,this.currentLine.startPoint=null}else this.currentLine.startPoint=e,this.currentLine.from=null;else if(this.lineCache.operation===s.lineOperations.endPointChange)if(i.length>0){i.sort(ht);const t=i.pop();this.currentLine.to=t.node,this.currentLine.toConOrder=t.order,this.currentLine.endPoint=null}else this.currentLine.endPoint=e,this.currentLine.to=null;this.currentLine.createPath(),Q.rollbackForMoving.call(this),Q.saveAll.call(this),this.currentLine.drawDashLine(this.lineCache.operation)},drawCurrentDashLine:function(t){this.lineCache.points[1].x===this.lineCache.points[3].x?(this.lineCache.points[1].x=t.offsetX*s.ratio,this.lineCache.points[3].x=t.offsetX*s.ratio):this.lineCache.points[1].y===this.lineCache.points[3].y&&(this.lineCache.points[1].y=t.offsetY*s.ratio,this.lineCache.points[3].y=t.offsetY*s.ratio),Q.rollbackForMoving.call(this),Q.saveAll.call(this),this.currentLine.drawDashLine(this.lineCache.operation)},drawNewDashLine:function(t){let e={},i=[];e.x=t.offsetX*s.ratio,e.y=t.offsetY*s.ratio,this.mouseOverNode&&(this.mouseOverNode.isOver=!1,this.mouseOverNode=null,Q.reload.call(this,!1));for(const t of this.nodes)t.shape.anchor.draw();if(this.currentLine)this.currentLine.endPoint=e,this.currentLine.to=null;else{let t={};this.startPoint&&this.startPoint.from&&(t.from=this.startPoint.from,t.fromConOrder=this.startPoint.order,t.endPoint=e),this.currentLine=Q.createRelation.call(this,t)}for(const e of this.nodes){const n=e.shape.connector.connectCheck(t.offsetX*s.ratio,t.offsetY*s.ratio);if(n){let t={};t.node=e,t.distance=n.distance,t.order=n.order,i.push(t)}}if(i.length>0){i.sort(ht);const t=i.pop();this.currentLine.to=t.node,this.currentLine.toConOrder=t.order,this.currentLine.endPoint=null}this.currentLine.createPath(),Q.rollbackForMoving.call(this),Q.saveAll.call(this),this.currentLine.drawDashLine(s.lineOperations.endPointChange)},drawDashShape:function(t){this.start_x=null,this.end_x=null,this.start_y=null,this.end_y=null;const e=t.offsetX*s.ratio-this.clickPoint.x,i=t.offsetY*s.ratio-this.clickPoint.y;if(Q.rollbackForMoving.call(this),!(Math.abs(e)<5&&Math.abs(i)<5))if(this.selectedElement instanceof P){const t={x:this.selectedElement.shape.center.x+e,y:this.selectedElement.shape.center.y+i},s=function(t,e,i){const s=[];t.map(t=>{t.shape.center.x>e.x&&i!==t&&s.push(t)}),s.sort(et);for(const t of s)if(t.shape.top<=e.y&&t.shape.bottom>=e.y)return t;return null}(this.nodes,t,this.selectedElement),n=function(t,e,i){const s=[];t.map(t=>{t.shape.center.x<e.x&&i!==t&&s.push(t)}),s.sort(it);for(const t of s)if(t.shape.top<=e.y&&t.shape.bottom>=e.y)return t;return null}(this.nodes,t,this.selectedElement),h=function(t,e,i){const s=[];t.map(t=>{t.shape.center.y<e.y&&i!==t&&s.push(t)}),s.sort(st);for(const t of s)if(t.shape.left<=e.x&&t.shape.right>=e.x)return t;return null}(this.nodes,t,this.selectedElement),o=function(t,e,i){const s=[];t.map(t=>{t.shape.center.y>e.y&&i!==t&&s.push(t)}),s.sort(nt);for(const t of s)if(t.shape.left<=e.x&&t.shape.right>=e.x)return t;return null}(this.nodes,t,this.selectedElement);let r=!1,a=!1,l=!1,c=!1,d=0,x=0,f=0,u=0;s&&t.y>=s.shape.center.y-10&&t.y<=s.shape.center.y+10&&(r=!0,d=s.shape.center.y-t.y),n&&t.y>=n.shape.center.y-10&&t.y<=n.shape.center.y+10&&(a=!0,x=n.shape.center.y-t.y),h&&t.x>=h.shape.center.x-10&&t.x<=h.shape.center.x+10&&(l=!0,f=h.shape.center.x-t.x),o&&t.x>=o.shape.center.x-10&&t.x<=o.shape.center.x+10&&(c=!0,u=o.shape.center.x-t.x),l?c?h.shape.center.x===o.shape.center.x?(this.offset_X=f,t.x=h.shape.center.x,this.start_y={x:t.x,y:h.shape.center.y-h.shape.height/2-15},this.end_y={x:t.x,y:o.shape.center.y+h.shape.height/2+15}):Math.abs(u)<Math.abs(f)?(this.offset_X=u,Q.saveStateForLine_Bottom.call(this,t,o)):(this.offset_X=f,Q.saveStateForLine_Top.call(this,t,h)):(this.offset_X=f,Q.saveStateForLine_Top.call(this,t,h)):c&&(this.offset_X=u,Q.saveStateForLine_Bottom.call(this,t,o)),r?a?s.shape.center.y===n.shape.center.y?(this.offset_Y=d,t.y=s.shape.center.y,this.start_x={x:n.shape.center.x-n.shape.width/2-15,y:t.y},this.end_x={x:s.shape.center.x+s.shape.width/2+15,y:t.y}):Math.abs(d)<Math.abs(x)?(this.offset_Y=d,Q.saveStateForLine_Right.call(this,t,s)):(this.offset_Y=x,Q.saveStateForLine_Left.call(this,t,n)):(this.offset_Y=d,Q.saveStateForLine_Right.call(this,t,s)):a&&(this.offset_Y=x,Q.saveStateForLine_Left.call(this,t,n)),Q.saveAll.call(this),this.start_x&&this.end_x&&tt(this.start_x,this.end_x,this.ctx),this.start_y&&this.end_y&&tt(this.start_y,this.end_y,this.ctx),this.selectedElement.drawDashNode(e+this.offset_X,i+this.offset_Y)}else this.selectedElement instanceof B&&(Q.saveAll.call(this),this.selectedElement.drawDashGroup(e,i))},moveSelectedElement:function(t){this.resetEventListener();const e=t.offsetX*s.ratio-this.clickPoint.x,i=t.offsetY*s.ratio-this.clickPoint.y;Q.rollbackForMoving.call(this),this.moveCache=null,(Math.abs(e)>5||Math.abs(i)>5)&&(this.selectedElement instanceof P?Q.moveShape.call(this,e+this.offset_X,i+this.offset_Y):this.selectedElement instanceof B&&Q.moveGroup.call(this,e,i),Q.saveStepCache.call(this))},drawLine:function(t){this.resetEventListener();const e={};if(e.x=t.offsetX*s.ratio,e.y=t.offsetY*s.ratio,this.currentLine&&!this.lineCache){this.currentLine.to?(this.currentLine.endPoint=null,ot(this.currentLine.to.relations,this.currentLine)):this.currentLine.endPoint=e,this.currentLine.createPath(),this.selectedElement=this.currentLine,this.currentLine=null,Q.reload.call(this);let t=J.selectedElement;t.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(t),t.element=null,Q.saveStepCache.call(this)}else if(this.currentLine&&this.lineCache){if(this.selectedElement.index=this.indexMark,this.indexMark++,this.lineCache.operation!==s.lineOperations.middlePathChange){if(this.currentLine.from&&this.lineCache.from===this.currentLine.from&&this.lineCache.fromConOrder===this.currentLine.fromConOrder&&this.currentLine.to&&this.lineCache.to===this.currentLine.to&&this.lineCache.toConOrder===this.currentLine.toConOrder)return this.lineCache=null,void Q.reload.call(this);this.lineCache.from&&this.lineCache.from.relations.splice(this.lineCache.from.relations.findIndex(t=>t===this.currentLine),1),this.lineCache.to&&this.lineCache.to.relations.splice(this.lineCache.to.relations.findIndex(t=>t===this.currentLine),1),this.currentLine.from?(this.currentLine.startPoint=null,ot(this.currentLine.from.relations,this.currentLine)):this.currentLine.operation===s.lineOperations.startPointChange&&(this.currentLine.startPoint=e),this.currentLine.to?(this.currentLine.endPoint=null,ot(this.currentLine.to.relations,this.currentLine)):this.currentLine.operation===s.lineOperations.endPointChange&&(this.currentLine.endPoint=e),this.currentLine.createPath()}else if(this.clickPoint.x===e.x&&this.clickPoint.y===e.y)return this.lineCache=null,void Q.reload.call(this);Q.reload.call(this),Q.saveStepCache.call(this)}this.currentLine=null,this.lineCache=null,this.selectedConnector=null,this.moveCache=null},mouseOverSelect:function(t){if(this.selectedElement){if(this.selectedElement instanceof X){let e=!1;if(e=this.selectedElement.line.controller.hitCheck(t.offsetX*s.ratio,t.offsetY*s.ratio))return void(e.operation===s.lineOperations.startPointChange||e.operation===s.lineOperations.endPointChange?this.canvas.style.cursor="crosshair":e.points[1].x===e.points[3].x?this.canvas.style.cursor="e-resize":e.points[1].y===e.points[3].y&&(this.canvas.style.cursor="n-resize"))}if(this.selectedElement instanceof P){let e=!1;if(e=this.selectedElement.shape.controller.hitCheck(t.offsetX*s.ratio,t.offsetY*s.ratio))return void("n"===e.order||"s"===e.order?this.canvas.style.cursor="n-resize":"e"===e.order||"w"===e.order?this.canvas.style.cursor="e-resize":"ne"===e.order||"sw"===e.order?this.canvas.style.cursor="ne-resize":"nw"!==e.order&&"se"!==e.order||(this.canvas.style.cursor="nw-resize"))}}let e=!1;if(this.mouseOverNode&&((e=this.mouseOverNode.connectorHitCheck(t.offsetX*s.ratio,t.offsetY*s.ratio))&&!this.selectedConnector?(Q.saveStateForConnector.call(this,this.mouseOverNode),this.mouseOverNode.selectConnector(e),this.selectedConnector={},this.selectedConnector.node=this.mouseOverNode,this.selectedConnector.order=e,this.canvas.style.cursor="default"):this.selectedConnector&&!e&&(Q.rollbackConnector.call(this),this.selectedConnector=null)),!e){let e=[];for(const i of this.elements)i.hitCheck(t.offsetX*s.ratio,t.offsetY*s.ratio)&&e.push(i);if(0===e.length)this.canvas.style.cursor="-webkit-grab";else{e.sort(function(t,e){return t.index-e.index});const t=e.pop();t instanceof P?this.canvas.style.cursor="move":t instanceof X&&(this.canvas.style.cursor="default")}e=[];for(const i of this.nodes)i.hitCheck_Over(t.offsetX*s.ratio,t.offsetY*s.ratio)?e.push(i):!0===i.isOver&&(i.isOver=!1,Q.reload.call(this));if(e.sort(function(t,e){return t.index-e.index}),0===e.length)this.mouseOverNode=null;else{const t=e.pop();for(const i of e)if(!0===i.isOver&&i.index<t.index){i.isOver=!1,Q.reload.call(this);break}(!this.mouseOverNode||this.mouseOverNode&&t!==this.mouseOverNode)&&(this.mouseOverNode=t,t.isOver=!0,this.mouseOverNode.drawConnector())}}},nodeResizing:function(t){const e=t.offsetX*s.ratio-this.clickPoint.x,i=t.offsetY*s.ratio-this.clickPoint.y;this.selectedElement.index+1!==this.indexMark&&(this.selectedElement.index=this.indexMark,this.indexMark++);const n=this.nodeResizeCache.y+this.nodeResizeCache.height/2,h=this.nodeResizeCache.y-this.nodeResizeCache.height/2,o=this.nodeResizeCache.x-this.nodeResizeCache.width/2,r=this.nodeResizeCache.x+this.nodeResizeCache.width/2;let a,l,c,d;switch(this.nodeResizeCache.direction){case"n":a=this.nodeResizeCache.height-i<20?20:this.nodeResizeCache.height-i,a=this.selectedElement.shape.nodeResizing(this.nodeResizeCache,a),this.selectedElement.shape.y=n-a/2,this.selectedElement.shape.height=a;break;case"s":a=this.nodeResizeCache.height+i<20?20:this.nodeResizeCache.height+i,a=this.selectedElement.shape.nodeResizing(this.nodeResizeCache,a),this.selectedElement.shape.y=h+a/2,this.selectedElement.shape.height=a;break;case"e":l=this.nodeResizeCache.width+e<20?20:this.nodeResizeCache.width+e,l=this.selectedElement.shape.nodeResizing(this.nodeResizeCache,l),this.selectedElement.shape.x=o+l/2,this.selectedElement.shape.width=l;break;case"w":l=this.nodeResizeCache.width-e<20?20:this.nodeResizeCache.width-e,l=this.selectedElement.shape.nodeResizing(this.nodeResizeCache,l),this.selectedElement.shape.x=r-l/2,this.selectedElement.shape.width=l;break;case"ne":c=20,d=20,this.nodeResizeCache.width>this.nodeResizeCache.height?c=20*this.nodeResizeCache.width/this.nodeResizeCache.height:d=20*this.nodeResizeCache.height/this.nodeResizeCache.width,(a=this.nodeResizeCache.height-i<d?d:this.nodeResizeCache.height-i)/(l=this.nodeResizeCache.width+e<c?c:this.nodeResizeCache.width+e)>this.nodeResizeCache.height/this.nodeResizeCache.width?l=a*this.nodeResizeCache.width/this.nodeResizeCache.height:a=l*this.nodeResizeCache.height/this.nodeResizeCache.width,this.selectedElement.shape.x=o+l/2,this.selectedElement.shape.y=n-a/2,this.selectedElement.shape.height=a,this.selectedElement.shape.width=l;break;case"se":c=20,d=20,this.nodeResizeCache.width>this.nodeResizeCache.height?c=20*this.nodeResizeCache.width/this.nodeResizeCache.height:d=20*this.nodeResizeCache.height/this.nodeResizeCache.width,(a=this.nodeResizeCache.height+i<d?d:this.nodeResizeCache.height+i)/(l=this.nodeResizeCache.width+e<c?c:this.nodeResizeCache.width+e)>this.nodeResizeCache.height/this.nodeResizeCache.width?l=a*this.nodeResizeCache.width/this.nodeResizeCache.height:a=l*this.nodeResizeCache.height/this.nodeResizeCache.width,this.selectedElement.shape.x=o+l/2,this.selectedElement.shape.y=h+a/2,this.selectedElement.shape.height=a,this.selectedElement.shape.width=l;break;case"sw":c=20,d=20,this.nodeResizeCache.width>this.nodeResizeCache.height?c=20*this.nodeResizeCache.width/this.nodeResizeCache.height:d=20*this.nodeResizeCache.height/this.nodeResizeCache.width,(a=this.nodeResizeCache.height+i<d?d:this.nodeResizeCache.height+i)/(l=this.nodeResizeCache.width-e<c?c:this.nodeResizeCache.width-e)>this.nodeResizeCache.height/this.nodeResizeCache.width?l=a*this.nodeResizeCache.width/this.nodeResizeCache.height:a=l*this.nodeResizeCache.height/this.nodeResizeCache.width,this.selectedElement.shape.x=r-l/2,this.selectedElement.shape.y=h+a/2,this.selectedElement.shape.height=a,this.selectedElement.shape.width=l;break;case"nw":c=20,d=20,this.nodeResizeCache.width>this.nodeResizeCache.height?c=20*this.nodeResizeCache.width/this.nodeResizeCache.height:d=20*this.nodeResizeCache.height/this.nodeResizeCache.width,(a=this.nodeResizeCache.height-i<d?d:this.nodeResizeCache.height-i)/(l=this.nodeResizeCache.width-e<c?c:this.nodeResizeCache.width-e)>this.nodeResizeCache.height/this.nodeResizeCache.width?l=a*this.nodeResizeCache.width/this.nodeResizeCache.height:a=l*this.nodeResizeCache.height/this.nodeResizeCache.width,this.selectedElement.shape.x=r-l/2,this.selectedElement.shape.y=n-a/2,this.selectedElement.shape.height=a,this.selectedElement.shape.width=l}this.selectedElement.relations.map(t=>{t.createPath(),t.index=this.indexMark,this.indexMark++}),Q.reload.call(this)},nodeResized:function(t){this.resetEventListener(),Q.saveStepCache.call(this)},keyDown:function(t){const e={x:-1,y:0},i={x:0,y:-1},s={x:1,y:0},n={x:0,y:1};46===t.keyCode&&this.selectedElement?(t.preventDefault(),Q.deleteEle.call(this)):90===t.keyCode&&t.ctrlKey?(t.preventDefault(),Q.undo.call(this)):89===t.keyCode&&t.ctrlKey?(t.preventDefault(),Q.redo.call(this)):83===t.keyCode&&t.ctrlKey?(t.preventDefault(),Q.save.call(this)):37===t.keyCode?(t.preventDefault(),Q.moveShapeOrGroup.call(this,e)):38===t.keyCode?(t.preventDefault(),Q.moveShapeOrGroup.call(this,i)):39===t.keyCode?(t.preventDefault(),Q.moveShapeOrGroup.call(this,s)):40===t.keyCode&&(t.preventDefault(),Q.moveShapeOrGroup.call(this,n))},resize:function(t){if(this.widthFunc||this.heightFunc){if(this.widthFunc){const t=this.widthFunc();this.canvas.style.width=t+"px",this.canvas.width=t*s.ratio}if(this.heightFunc){const t=this.heightFunc();this.canvas.style.height=t+"px",this.canvas.height=t*s.ratio}Q.reload.call(this)}},mouseLeaveHandler:function(t){this.resetEventListener(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.load(this.stepCache[this.stepMark],!0),this.currentLine=null,this.lineCache=null,this.selectedConnector=null,this.moveCache=null,this.selectedElement=null},canvasMoveLeave:function(t){this.resetEventListener(),this.canvasMoveCache=null},moveCanvasOrCompose:function(t){const e=t.offsetX*s.ratio-this.clickPoint.x,i=t.offsetY*s.ratio-this.clickPoint.y;if(this.composeModel&&t.ctrlKey){Q.rollbackForMoving.call(this),Q.saveAll.call(this);let n={x:this.clickPoint.x,y:this.clickPoint.y},h=0,o=0;e>0&&i>0?(h=e,o=i):e>0&&i<0?(n.y=t.offsetY*s.ratio,h=e,o=-1*i):e<0&&i>0?(n.x=t.offsetX*s.ratio,h=-1*e,o=i):e<0&&i<0&&(n.x=t.offsetX*s.ratio,n.y=t.offsetY*s.ratio,h=-1*e,o=-1*i),this.ctx.save(),this.ctx.lineWidth=.7,this.ctx.setLineDash([6,3]),this.ctx.lineDashOffset=0,this.ctx.strokeRect(n.x,n.y,h,o),this.ctx.restore()}else if(this.composeModel&&!t.ctrlKey)this.composeModel=!1;else{if(!this.canvasMoveCache){this.canvasMoveCache=[];for(const t of this.elements){const e={};t instanceof P?(e.id=t.id,e.x=t.shape.x,e.y=t.shape.y,this.canvasMoveCache.push(e)):t instanceof X&&(e.id=t.id,t.from||(e.startPoint={},e.startPoint.x=t.startPoint.x,e.startPoint.y=t.startPoint.y),t.to||(e.endPoint={},e.endPoint.x=t.endPoint.x,e.endPoint.y=t.endPoint.y),t.line.inflexionPoint&&(e.inflexionPoint=y.deepClone(t.line.inflexionPoint)),this.canvasMoveCache.push(e))}}for(const t of this.canvasMoveCache){let s;if(Object.hasOwnProperty.call(this.elementDict,t.id))if((s=this.elementDict[t.id])instanceof P)s.shape.x=t.x+e,s.shape.y=t.y+i;else if(s instanceof X&&(s.from||(s.startPoint.x=t.startPoint.x+e,s.startPoint.y=t.startPoint.y+i),s.to||(s.endPoint.x=t.endPoint.x+e,s.endPoint.y=t.endPoint.y+i),s.line.inflexionPoint)){s.line.inflexionPoint=[];for(const n of t.inflexionPoint){const t={};t.x=n.x+e,t.y=n.y+i,s.line.inflexionPoint.push(t)}}}Q.reload.call(this)}},moveCanvasComplete:function(t){if(this.resetEventListener(),this.canvasMoveCache=null,this.composeModel){this.composeModel=!1,Q.rollbackForMoving.call(this);const e=this.clickPoint.x<t.offsetX*s.ratio?this.clickPoint.x:t.offsetX*s.ratio,i=this.clickPoint.y<t.offsetY*s.ratio?this.clickPoint.y:t.offsetY*s.ratio,n=this.clickPoint.x>t.offsetX*s.ratio?this.clickPoint.x:t.offsetX*s.ratio,h=this.clickPoint.y>t.offsetY*s.ratio?this.clickPoint.y:t.offsetY*s.ratio,o=this.nodes.filter(t=>i<=t.shape.top&&e<=t.shape.left&&n>=t.shape.right&&h>=t.shape.bottom);1===o.length?(this.selectedElement=o[0],Q.reload.call(this)):o.length>1&&(this.selectedElement=new B(this.canvas),this.selectedElement.nodes=o,this.selectedElement.relations=this.relations.filter(t=>-1!==o.indexOf(t.from)&&-1!==o.indexOf(t.to)),Q.reload.call(this));let r=J.selectedElement;r.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(r),r.element=null}},mouseEnterEventHandler:function(t){this.removeEventListener("mouseenter",this.mouseEnterEventHandler),this.removeEventListener("mousemove",this.mouseOverSelect),this.clickPoint.x=t.offsetX*s.ratio,this.clickPoint.y=t.offsetY*s.ratio,this.dragedNode.x=t.offsetX*s.ratio,this.dragedNode.y=t.offsetY*s.ratio,this.selectedElement=Q.createNode.call(this,this.dragedNode,!0),this.addEventListener("mouseup",this.addNewNode),this.addEventListener("mousemove",this.drawDashShape),this.addEventListener("mouseleave",this.mouseLeaveHandler)},addNewNode:function(t){this.resetEventListener();const e=t.offsetX*s.ratio-this.clickPoint.x,i=t.offsetY*s.ratio-this.clickPoint.y;Q.rollbackForMoving.call(this),this.moveCache=null,this.nodes.push(this.selectedElement),this.elements.push(this.selectedElement),this.elementDict[this.selectedElement.id]=this.selectedElement,Q.moveShape.call(this,e+this.offset_X,i+this.offset_Y);let n=J.selectedElement;n.element=Q.outPutUnit(this.selectedElement),this.canvas.dispatchEvent(n),n.element=null,Q.saveStepCache.call(this)}};function tt(t,e,i){i&&(i.save(),i.beginPath(),i.lineWidth=.6,i.strokeStyle="rgb(150, 50, 50, 1)",i.moveTo(t.x,t.y),i.lineTo(e.x,e.y),i.stroke(),i.restore())}function et(t,e){return t.shape.center.x-e.shape.center.x}function it(t,e){return e.shape.center.x-t.shape.center.x}function st(t,e){return e.shape.center.y-t.shape.center.y}function nt(t,e){return t.shape.center.y-e.shape.center.y}function ht(t,e){return e.distance-t.distance}function ot(t,e){for(const i of t)if(e===i)return!1;return t.push(e),!0}class rt extends Error{constructor(t){super(t),this.name="NoSuchCommandError"}}class at extends Error{constructor(t){super(t),this.name="NoSuchEventError"}}i.d(e,"GraphEditor",function(){return lt});class lt{constructor(t,e){this.initial(),this.stepCache=[],this.stepCache.push([]),this.stepMark=0,this.eventDict={},this.widthFunc,this.heightFunc,this.canvasWidth,this.canvasHeight;let i=Object.prototype.toString.call(t);"[object Function]"===i?(this.widthFunc=t,this.canvasWidth=t()):"[object Number]"===i&&(this.canvasWidth=t),"[object Function]"===(i=Object.prototype.toString.call(e))?(this.heightFunc=e,this.canvasHeight=e()):"[object Number]"===i&&(this.canvasHeight=e),this.canvas=function(t,e){const i=document.getElementById("canvas"),n=document.createElement("canvas"),h=t||i.width,o=e||i.height;return n.style.width=h+"px",n.style.height=o+"px",n.width=h*s.ratio,n.height=o*s.ratio,i.appendChild(n),n}(this.canvasWidth,this.canvasHeight),this.ctx=this.canvas.getContext("2d"),this.ctx.imageSmoothingEnabled=!0,this.ctx.lineJoin="round",this.ctx.lineCap="round",this.drawNewDashLine=t=>$.drawNewDashLine.call(this,t),this.drawDashShape=t=>$.drawDashShape.call(this,t),this.moveSelectedElement=t=>$.moveSelectedElement.call(this,t),this.mouseOverSelect=t=>$.mouseOverSelect.call(this,t),this.drawLine=t=>$.drawLine.call(this,t),this.changeStartOrEndOfLine=t=>$.changeStartOrEndOfLine.call(this,t),this.drawCurrentDashLine=t=>$.drawCurrentDashLine.call(this,t),this.mouseLeaveHandler=t=>$.mouseLeaveHandler.call(this,t),this.moveCanvasOrCompose=t=>$.moveCanvasOrCompose.call(this,t),this.moveCanvasComplete=t=>$.moveCanvasComplete.call(this,t),this.canvasMoveLeave=t=>$.canvasMoveLeave.call(this,t),this.nodeResizing=t=>$.nodeResizing.call(this,t),this.nodeResized=t=>$.nodeResized.call(this,t),this.mouseEnterEventHandler=t=>$.mouseEnterEventHandler.call(this,t),this.addNewNode=t=>$.addNewNode.call(this,t),this.mouseUpEventHandler=t=>(function(t){this.resetEventListener(),window.removeEventListener("mouseup",this.mouseUpEventHandler)}).call(this,t),this.addEventListener("mousedown",t=>{document.activeElement.blur(),$.mouseDownEventHandler.call(this,t)}),this.addEventListener("mousemove",this.mouseOverSelect),window.addEventListener("keydown",t=>$.keyDown.call(this,t)),window.addEventListener("resize",t=>$.resize.call(this,t))}initial(){this.nodes=[],this.relations=[],this.elements=[],this.elementDict={},this.selectedElement=null,this.mouseOverNode=null,this.moveCache=null,this.indexMark=0,this.clickPoint={},this.offset_Y=0,this.start_x=null,this.end_x=null,this.offset_X=0,this.start_y=null,this.end_y=null,this.connectorCache=null,this.selectedConnector=null,this.startPoint=null,this.currentLine=null,this.lineCache=null,this.nodeResizeCache=null,this.itemPannelEle=null,this.dragedNode=null,this.detailPannelEle=null,this.canvasMoveCache=null,this.toolbarEle=null,this.composeModel=!1}load(t,e=!1){this.initial(),e||(this.stepCache=[],this.stepCache.push([]),this.stepMark=0),t.nodes||(t.nodes=[]),t.relations||(t.relations=[]);let i=t.nodes.concat(t.relations);i.sort(function(t,e){return t.index-e.index});for(const t of i)if(t.type===s.elementTypes.node){const e=t.size.split("*");let i={id:t.id,strokeStyle:t.edgeColor,fillStyle:t.color,type:t.type,shape:t.shape,text:{content:t.label,fontSize:t.fontSize,textAlign:t.textAlign,textBaseline:t.textBaseline},index:t.index,width:parseInt(e[0]),height:parseInt(e[1]),x:t.x,y:t.y,customProperties:t.customProperties};Q.createNode.call(this,i)}else if(t.type===s.elementTypes.relation){let e={id:t.id,strokeStyle:t.color,type:t.type,text:{content:t.label,fontSize:t.fontSize},index:t.index,fromConOrder:t.fromConOrder,toConOrder:t.toConOrder,inflexionPoint:t.inflexionPoint,startPoint:t.startPoint,endPoint:t.endPoint,lineModel:t.lineModel,customProperties:t.customProperties};t.source&&Object.hasOwnProperty.call(this.elementDict,t.source)&&(e.from=this.elementDict[t.source]),t.target&&Object.hasOwnProperty.call(this.elementDict,t.target)&&(e.to=this.elementDict[t.target]),Q.createRelation.call(this,e).draw()}e||(this.stepCache.push(Q.outPut(this.elements)),this.stepMark=this.stepCache.length-1)}addEventListener(t,e){let i=!0;if(Object.hasOwnProperty.call(this.eventDict,t)){let s=this.eventDict[t].filter(function(t){return t===e});s&&0!==s.length||(i=!1)}else this.eventDict[t]=[],i=!1;i||(this.eventDict[t].push(e),this.canvas.addEventListener(t,e))}removeEventListener(t,e){let i=!0;if(Object.hasOwnProperty.call(this.eventDict,t)){let s=this.eventDict[t].filter(function(t){return t===e});s&&0!==s.length||(i=!1)}else this.eventDict[t]=[],i=!1;i&&(this.eventDict[t].splice(this.eventDict[t].indexOf(e),1),this.canvas.removeEventListener(t,e))}resetEventListener(){for(const t in this.eventDict)if(Object.hasOwnProperty.call(this.eventDict,t)){const e=this.eventDict[t];for(let i=0;i<e.length;i++){const s=e[i];this.canvas.removeEventListener(t,s)}}this.eventDict={},this.addEventListener("mousedown",t=>{document.activeElement.blur(),$.mouseDownEventHandler.call(this,t)}),this.addEventListener("mousemove",this.mouseOverSelect)}get data(){return Q.outPut(this.elements)}on(t,e){if(!J[t])throw new at("编辑器不支持此事件。");"click"===t&&(t="canvasClick"),this.canvas.addEventListener(t,e)}update(t,e){Object.hasOwnProperty.call(this.elementDict,t)&&(-1!==s.properties.indexOf(e.name)?(this.elementDict[t][e.name]=e.value,Q.saveStepCache.call(this),Q.reload.call(this)):this.elementDict[t].customProperties[e.name]=e.value)}set itemPannel(t){document.body.onselectstart=function(){return!1},this.itemPannelEle=document.getElementById(t);for(const t of this.itemPannelEle.children)t.addEventListener("mousedown",t=>ct.call(this,t))}set detailPannel(t){this.detailPannelEle=document.getElementById(t)}set toolbar(t){this.toolbarEle=document.getElementById(t);for(const t of this.toolbarEle.childNodes)if(t.getAttribute&&t.getAttribute("data-command"))switch(t.getAttribute("data-command")){case"undo":t.addEventListener("click",t=>Q.undo.call(this));break;case"redo":t.addEventListener("click",t=>Q.redo.call(this));break;case"delete":t.addEventListener("click",t=>Q.deleteEle.call(this));break;case"save":t.addEventListener("click",t=>Q.save.call(this));break;case"alignLeft":t.addEventListener("click",t=>Q.changeTextAlign.call(this,"left"));break;case"alignCenter":t.addEventListener("click",t=>Q.changeTextAlign.call(this,"center"));break;case"alignRight":t.addEventListener("click",t=>Q.changeTextAlign.call(this,"right"));break;case"baselineTop":t.addEventListener("click",t=>Q.changeBaseline.call(this,"top"));break;case"baselineMiddle":t.addEventListener("click",t=>Q.changeBaseline.call(this,"middle"));break;case"baselineBottom":t.addEventListener("click",t=>Q.changeBaseline.call(this,"bottom"));break;default:throw new rt("编辑器不支持此命令。")}}set width(t){const e=Object.prototype.toString.call(t);if("[object Function]"===e){this.widthFunc=t;const e=this.widthFunc();this.canvas.style.width=e+"px",this.canvas.width=e*s.ratio}else"[object Number]"===e&&(this.canvas.style.width=t+"px",this.canvas.width=t*s.ratio)}set height(t){const e=Object.prototype.toString.call(t);if("[object Function]"===e){this.heightFunc=t;const e=this.heightFunc();this.canvas.style.height=e+"px",this.canvas.height=e*s.ratio}else"[object Number]"===e&&(this.canvas.style.height=t+"px",this.canvas.height=t*s.ratio)}}function ct(t){this.dragedNode={};let e=null;const i=(e="div"===t.target.localName?t.target:t.target.parentNode).getAttribute("data-size").split("*");this.dragedNode.type="node",this.dragedNode.shape=e.getAttribute("data-shape"),this.dragedNode.width=parseInt(i[0])*s.ratio,this.dragedNode.height=parseInt(i[1])*s.ratio,this.dragedNode.text={},this.dragedNode.text.content=e.getAttribute("data-label"),this.dragedNode.fillStyle=e.getAttribute("data-color"),this.dragedNode.strokeStyle=e.getAttribute("data-edgecolor"),this.addEventListener("mouseenter",this.mouseEnterEventHandler),window.addEventListener("mouseup",this.mouseUpEventHandler)}window.GraphEditor=lt}});